<!DOCTYPE html>
<html>
  <head>
    <title>Slot Machine</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  </head>
  <body>

    <div id="background" class="container">
      <div class="row">
        <div class="col-xs-8 col-xs-offset-2 border text-center"><h1>Beverage Slot Machine</h1></div>
      </div>
      <div class="row border spinner-container">
        <div id="first" class="col-xs-4 border"></div>
        <div id="second" class="col-xs-4 border"></div>
        <div id="third" class="col-xs-4 border"></div>
      </div>
      <div class="row border">
        <h3 class="text-center">Winners!</h3>
        
        <div class="row">
          <div class="col-xs-2 col-xs-offset-2">
            <div class="row">
              <div class="col-xs-6 center-parent">
                <img class="img-responsive center" src="coffeemaker.png"></img>
              </div>
              <div class="col-xs-6">
                <h2 class="text-center symbol">+</h2>
              </div>
            </div>
          </div>

          <div class="col-xs-2">
            <div class="row">
              <div class="col-xs-6 center-parent">
                <img class=" img-responsive center" src="coffee-filter.jpg"></img>
              </div>
              <div class="col-xs-6">
                <h2 class="text-center symbol">+</h2>
              </div>
            </div>
          </div>

          <div class="col-xs-2">
            <div class="row">
              <div class="col-xs-6 center-parent">
                <img class=" img-responsive center" src="coffee-grounds.jpg"></img>
              </div>
              <div class="col-xs-6">
                <h2 class="text-center symbol">=</h2>
              </div>
            </div>
          </div>

          <div class="col-xs-2">
            <div class="row">
              <div class="col-xs-6 col-xs-offset-3 center-parent">
                <img class=" img-responsive center" src="cup-coffee.png" />
              </div>
            </div>
          </div>
        </div>
        
        <div class="row">
          
          <div class="col-xs-2 col-xs-offset-2">
            <div class="row">
              <div class="col-xs-6 center-parent">
                <img class=" img-responsive center" src="espressomachine.jpg"></img>
              </div>
              <div class="col-xs-6">
                <h2 class="text-center symbol">+</h2>
              </div>
            </div>
          </div>

          <div class="col-xs-2">
            <div class="row">
              <div class="col-xs-6 center-parent">
                <img class=" img-responsive center" src="espresso-tamper.jpg"></img>
              </div>
              <div class="col-xs-6">
                <h2 class="text-center symbol">+</h2>
              </div>
            </div>
          </div>

          <div class="col-xs-2">
            <div class="row">
              <div class="col-xs-6 center-parent">
                <img class=" img-responsive center" src="espresso-beans.jpg"></img>
              </div>
              <div class="col-xs-6">
                <h2 class="text-center symbol">=</h2>
              </div>
            </div>
          </div>

          <div class="col-xs-2">
            <div class="row">
              <div class="col-xs-6 col-xs-offset-3 center-parent">
                <img class=" img-responsive center" src="cup-coffee.png" />
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-xs-2 col-xs-offset-2">
            <div class="row">
              <div class="col-xs-6 center-parent">
                <img class=" img-responsive center" src="teapot.jpg"></img>
              </div>
              <div class="col-xs-6">
                <h2 class="text-center symbol">+</h2>
              </div>
            </div>
          </div>

          <div class="col-xs-2">
            <div class="row">
              <div class="col-xs-6 center-parent">
                <img class=" img-responsive center" src="tea-strainer.jpg"></img>
              </div>
              <div class="col-xs-6">
                <h2 class="text-center symbol">+</h2>
              </div>
            </div>
          </div>

          <div class="col-xs-2">
            <div class="row">
              <div class="col-xs-6 center-parent">
                <img class=" img-responsive center" src="loose-tea.jpg"></img>
              </div>
              <div class="col-xs-6">
                <h2 class="text-center symbol">=</h2>
              </div>
            </div>
          </div>

          <div class="col-xs-2">
            <div class="row">
              <div class="col-xs-6 col-xs-offset-3 center-parent">
                <img class=" img-responsive center" src="cup-coffee.png" />
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="row">
        <div class="col-xs-12 border">
          <button class="btn btn-primary btn-block btn-lg" id="pull">Pull Lever</button>
        </div>
      </div>
    </div>

    <div id="win-modal" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">You're a Winner!</h4>
          </div>
          <div class="modal-body">
            <p>It looks like you're having a nice warm cup of <span class="beverage"></span>!</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cool!</button>
          </div>
        </div>
      </div>
    </div>

    <style type="text/css">
      h1 {
        margin: 10px;
      }

      img {
        max-height: 250px;
      }

      button {
        padding: 20px;
      }

      .symbol {
        margin: 30px 0;
      }

      .border {
        border: solid 1px #ccc;
      }

      .center-parent {
        height: 100px;
        position: relative;
      }

      .center {
        position: absolute;
        left: 0; right: 0;
        top: 0; bottom: 0;
        margin: auto;
      }

      .spinner-container {
        height: 290px;
        overflow: hidden;
        padding: 20px 10%;
      }

      .spinner-container > div {
        overflow: hidden;
        height: 250px;
        position: relative;
      }

    </style>

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script> 
    
    <script>
      var AppView = Backbone.View.extend({

        events: {
          'click' : 'startTheMachine'
        },

        map: ['Coffee', 'Tea', 'Espresso'],

        initialize: function(){
          _(this).bindAll('checkWin');

          this.firstRoller = new RollerView({
            settings: ['coffeemaker.png', 'teapot.jpg', 'espressomachine.jpg'],
            spins: [5, 10],
            el: '#first'
          });

          this.secondRoller = new RollerView({
            settings: ['coffee-filter.jpg', 'tea-strainer.jpg', 'espresso-tamper.jpg'],
            spins: [10, 15],
            el: '#second'
          });
          
          this.thirdRoller = new RollerView({
            settings: ['coffee-grounds.jpg', 'loose-tea.jpg', 'espresso-beans.jpg'],
            spins: [15, 20],
            el: '#third'
          });

          this.listenTo(this.thirdRoller, 'finished', this.onFinish)

          this.firstRoller.render();
          this.secondRoller.render();
          this.thirdRoller.render();
        },

        onFinish: function(){
          this.checkWin();
          this.$el.removeAttr('disabled');
        },

        checkWin: function(){
          var unique = _([this.firstRoller.count, this.secondRoller.count, this.thirdRoller.count]).uniq();
          if (unique.length === 1){
            $('.beverage').text(this.map[unique[0]]);
            $('#win-modal').modal()
          }
        },

        startTheMachine: function(){
          this.$el.attr('disabled', 'disabled')

          this.firstRoller.spin(0);
          this.secondRoller.spin(0);
          this.thirdRoller.spin(0);
        },

        render: function(){
          return this;
        }
      });

      var RollerView = Backbone.View.extend({
        count: 0,
        template: _.template('<img class="img-responsive center item item-blur" src="<%= src %>"/>'),

        initialize: function(options){
          _(this).bindAll('removeImage', 'finished');

          this.settings = options.settings;
          this.spins = options.spins;
        },

        increment: function(){
          this.count = this.count >= 2 ? 0 : ++this.count;
        },

        spin: function(i){        
          var random = _.random(this.spins[0], this.spins[1]);

          setTimeout(_(function(){
            this.increment();
            this.moveImage();

            if (i < random){
              this.spin(++i);
            }
            else {
              _(this.finished).delay(150);
            }
          }).bind(this), 100);
        },

        finished: function(){
          this.trigger('finished');
        },

        moveImage: function(){
          this.$img.animate({
            marginTop: 200
          }, 50, 'swing', this.removeImage)
        },

        removeImage: function(){
          this.$img.remove();
          this.render();
        },

        render: function(spin){
          this.$el.html(this.template({
            src: this.settings[this.count]
          }));

          this.$img = this.$('img');

          return this
        }
      });

      var app = new AppView({ el: '#pull' }).render()

    </script>
   
  </body>
</html>           